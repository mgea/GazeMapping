<!DOCTYPE html>
<html lang="es">
<!--------------------------
  - GazeMapping : testing.html
  ------------------------->
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="gazemapping.ico">
    <link rel="shortcut icon" href="gazeMapping.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="application-name" content="GazeMapping">
    <meta name="author" content="Miguel Gea">
    <meta name="version" content="1.0.0">
    <meta name="description" content="Herramienta de an√°lisis visual GazeMapping para Dise√±o de Interfaces de Usuario">
    <meta name="keywords" content="UX, Eye tracking, Heatmap, UI Design, GazeMapping, An√°lisis de Usuario">
    <meta name="engine" content="WebGazer.js (https://webgazer.cs.brown.edu/)">
    <meta name="framework" content="Vanilla JS, Heatmap.js-logic">
    
    <meta name="subject" content="Dise√±o de Interfaces de Usuario">

    <title>GazeMapping - User testing multipages </title>
    <script src="https://cdn.jsdelivr.net/npm/webgazer@2.1.0/dist/webgazer.js"></script>
    <!-- IMPORTAMOS EL SCRIPT EXTERNO AQU√ç -->
    <script src="api.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            background-color: #111;
            font-family: sans-serif;
            overflow-x: hidden; 
        }

        #canvas-background {
            position: relative;
            width: 100%;
            z-index: 1;
        }

        #background-img {
            width: 100%;
            height: auto;
            display: block;
        }

        #capa-clics {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50;
            pointer-events: none;
        }

        .punto-clic {
            position: absolute;
            width: 20px; height: 20px;
            background-color: #ffeb3b;
            border: 2px solid #fbc02d;
            border-radius: 50%;
            color: #000;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Capas de WebGazer */
        #webgazerVideoContainer, #webgazerVideoCanvas, #webgazerFaceOverlay, #webgazerDot {
            z-index: 99999 !important;
            position: fixed !important;
            transition: opacity 0.3s;
        }

        .oculto-tracker {
            opacity: 0 !important;
            pointer-events: none !important;
            visibility: hidden !important;
        }

        /* Interfaz de Usuario */
        #estado-ui { 
            position: fixed; top: 10px; right: 10px; 
            background: rgba(0,0,0,0.85); color: lime; 
            padding: 15px; border-radius: 8px; 
            font-family: monospace; z-index: 1000; 
            border: 1px solid #444;
            min-width: 180px;
        }

        #stats {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #555;
            line-height: 1.5;
            background: transparent !important;
        }

        .coord-box {
            color: #fff;
            font-size: 0.9em;
            margin-top: 5px;
            display: block;
        }

        #instrucciones-inicio {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); color: white;
            padding: 40px; border-radius: 20px;
            text-align: center; z-index: 10001;
            border: 2px solid #fff;
            box-shadow: 0 0 30px rgba(0,0,0,1);
        }

        /* Calibraci√≥n */
        .cal-point {
            width: 30px; height: 30px;
            background-color: red; border: 2px solid white;
            border-radius: 50%; position: fixed;
            z-index: 10000; cursor: crosshair;
            opacity: 0.8; display: none;
        }
        .cal-point.active { background-color: yellow; transform: scale(1.4); }
        .cal-point.finished { display: none !important; }

        /* --- MEN√ö DE CONTROL --- */
        #controlMenu {
            display:none; 
            position:fixed; 
            top:50%; left:50%;
            transform: translate(-50%, -50%);
            width:300px; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            color: #000; 
            padding: 30px; 
            border-radius: 24px; 
            z-index: 11000;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.4);
            text-align: center;
        }

        #controlMenu h3 {
            margin: 0 0 25px 0;
            color: #000 !important;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1.1rem;
            letter-spacing: 1.5px;
        }

        .menu-btn { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            border: none; 
            border-radius: 14px; 
            font-weight: 700;
            font-size: 13px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .menu-btn:hover {
            transform: translateY(-3px);
            opacity: 0.9;
        }

        hr {
            border: 0; 
            height: 1px;
            background: rgba(0,0,0,0.1); 
            margin: 20px 0;
        }

        /* Resaltado para el mensaje de estado cuando ocurre algo importante */
        .status-highlight {
            color: #fff !important;
            background: #2ecc71;
            padding: 2px 5px;
            border-radius: 4px;
        }

    /* --- ESTILO DEL PANEL MODAL DE USUARIO --- */
    #modal-usuario {
        display: none; /* Se activa por JS */
        position: fixed;
        top: 40%;
        left: 70%;
        transform: translate(-50%, -50%);
        width: 340px;
        background: rgba(25, 25, 25, 0.95); /* Fondo oscuro profundo */
        backdrop-filter: blur(10px); /* Desenfoque de fondo */
        -webkit-backdrop-filter: blur(10px);
        color: white;
        padding: 35px;
        border-radius: 20px;
        z-index: 12000;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        text-align: left;
        animation: slideIn 0.3s ease-out;
    }

    #modal-usuario h3 {
        color: white;
        font-weight: 600; /* Para que resalte un poco m√°s */
        letter-spacing: 0.5px;
        margin-bottom: 20px;
        text-align: center;
        }

 


    </style>
</head>
<body>

    <div id="instrucciones-inicio">
        <h2>GazeMapping User Testing</h2>
        <p>Presiona <strong>[ ENTER ]</strong> para calibrar la mirada.</p>
        <p>Usa <strong>[ ‚Üê ‚Üí ]</strong> para cambiar de imagen <br> ubicaci√≥n en: public/site/1.png..</p>
        <p style="font-size: 0.9em; color: #aaa;">Usa Espacio durante la sesi√≥n para pausar/men√∫. <br>
            c : conmuta ventana de webcam<br>
            v : conmuta ventana de datos
        </p>

        <p style="font-size: 0.9em; color: #aaa;">CCBYNCSA  mgea  v1.0 2026 <br> 
            Basado en <a href="https://webgazer.cs.brown.edu/" target="_blank" style="color: inherit; text-decoration: underline;">WebGazer.j</a></p>
    </div>
    
    <div id="estado-ui">
        <div id="stats">
            <div>Sitio Actual: <span id="st-site">1</span></div>
            <hr style="border-color:#333">
            Puntos Gaze: <span id="st-gaze">0</span><br>
            Total Clics: <span id="st-clics">0</span>
            <div class="coord-box">
                Gaze X: <span id="cur-x">-</span><br>
                Gaze Y: <span id="cur-y">-</span>
            </div>
        </div>
        <div id="txt-estado">Listo para iniciar</div>
    </div>

    <div id="canvas-background">
        <!---- por defecto 1.png en SITES -->
        <img src="sites/1.png" id="background-img" alt="Imagen"> 
        <div id="capa-clics"></div>
    </div>

    <div id="calibration-group">
        <div class="cal-point" id="pt1" style="top: 10%; left: 10%;" onclick="calibrate(this)"></div>
        <div class="cal-point" id="pt2" style="top: 10%; left: 50%;" onclick="calibrate(this)"></div>
        <div class="cal-point" id="pt3" style="top: 10%; right: 10%;" onclick="calibrate(this)"></div>
        <div class="cal-point" id="pt4" style="top: 50%; left: 10%;" onclick="calibrate(this)"></div>
        <div class="cal-point" id="pt5" style="top: 50%; left: 50%;" onclick="calibrate(this)"></div>
        <div class="cal-point" id="pt6" style="top: 50%; right: 10%;" onclick="calibrate(this)"></div>
        <div class="cal-point" id="pt7" style="bottom: 10%; left: 10%;" onclick="calibrate(this)"></div>
        <div class="cal-point" id="pt8" style="bottom: 10%; left: 50%;" onclick="calibrate(this)"></div>
        <div class="cal-point" id="pt9" style="bottom: 10%; right: 10%;" onclick="calibrate(this)"></div>
    </div>

    <div id="controlMenu">
        <h3>Sesi√≥n Pausada</h3>
        <button class="menu-btn" onclick="location.reload()" style="background:#ff9f43; color:white;">Reiniciar Todo</button>
        <button class="menu-btn" onclick="eliminarUltimoClic()" style="background:#54a0ff; color:white;">Deshacer √öltimo Clic</button>
        <button class="menu-btn" onclick="exportarJSON()" style="background:#1dd1a1; color:white;">Exportar a JSON</button>
        <button class="menu-btn" onclick="window.location.href='/v.html'" style="background:#5f27cd; color:white;">Ver Mapa de Calor</button>
        <button class="menu-btn" onclick="finalizarSesion()" style="background:#96068ccd; color:#ffffff;">Finalizar Sesi√≥n</button>
   
        <hr>
        <button class="menu-btn" onclick="cerrarMenuYReanudar()" style="background:#111111; color:#ffffff;">Reanudar [Espacio]</button>
    </div>

    <div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:11999;"></div>

    <div id="modal-usuario">
        <h2>Finalizar Sesi√≥n</h2>
    
        <p> <label>Usuario / ID</label>

        <input type="text" id="user-name" placeholder="Ej: Participante_01"></p>
    
        <p> <label>Edad</label>
        <input type="number" id="user-age" placeholder="25" value="-1">
        </p>
    
        <label>Sexo</label>
            <select id="user-sex">
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
            <option value="?" selected>No definido</option>
        </select>

        <p> <label>Ubicaci√≥n</label>
        <input type="number" id="user-loc" placeholder="Ej: ETSIIT Granada" value="UGR-DIU">

        <p> <label>Grupo (caso de A/B testing)</label>
            <select id="user-group">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="N" selected>None</option>
            </select></p>

        
        <p> <label>Fecha de la Sesi√≥n</label>
        <input type="date" id="user-date" class="input-modal"> </p>

        <p></p>

        <button class="menu-btn" onclick="confirmarFinalizacion()" style="background:#0d833c; color:white;">üíæ Guardar y Terminar</button>
        <button class="menu-btn" onclick="cerrarModalUser()" style="background:transparent; color:#888; border:1px solid #444;">Cancelar</button>
    </div>


    


    <script>
        let acumuladorPuntos = [];
        let datosClics = [];
        let ultimoRegistro = 0;
        let iniciado = false;
        let calibracionTerminada = false;  // MODIFICAR EN PRUEBAS
        let trackerPausado = false; 
        let camaraManualVisible = true; 
        let currentSite = 1;               // MULTISITE
        let clicsPorPunto = {};
        const CLICS_NECESARIOS = 5;

    


       // --- NAVEGACI√ìN ENTRE SITIOS ---
       async function cambiarSitio(direccion) {
            // Guardar datos antes de limpiar si se desea, o avisar
            if (acumuladorPuntos.length > 0 || datosClics.length > 0) {
                console.log("Cambiando de sitio. Los datos deben ser exportados manualmente o se acumular√°n.");
            }

            if (direccion === 'next') {
               const existe = await existeFichero(currentSite + 1);
               if(existe)  currentSite++;
                  else return;
            }
            else {
               if ((direccion === 'previous')&&(currentSite>1)) currentSite--;
               else return;
            }
           
            const nuevaRuta = `sites/${currentSite}.png`;
             console.log("cambiando a ", nuevaRuta);
            const img = document.getElementById('background-img');
            
            // Intentar cargar la siguiente imagen
            img.src = nuevaRuta;
            document.getElementById('st-site').innerText = currentSite;
            
            // Actualizar localStorage para v.html
            localStorage.setItem('sharedImage', nuevaRuta);
            localStorage.setItem('currentSiteId', currentSite);

            setMensajeEstado(`Cambiado a Sitio ${currentSite}`);
            
            // Opcional: Limpiar datos autom√°ticamente al cambiar de sitio
            limpiarSesion();
        }


        function limpiarSesion() {
            datosClics = [];
            acumuladorPuntos = [];
            document.getElementById('capa-clics').innerHTML = '';
            actualizarUI();
            setMensajeEstado("Datos reseteados para Sitio " + currentSite);
        }

        // Funci√≥n para enviar mensajes al estado UI
        function setMensajeEstado(msg, persistente = false) {
            const el = document.getElementById('txt-estado');
            el.innerText = msg;
            
            if (!persistente) {
                // Si no es persistente (como un aviso de guardado), vuelve al estado l√≥gico despu√©s de 3s
                setTimeout(() => {
                    if (trackerPausado) el.innerText = "PAUSADO";
                    else if (calibracionTerminada) el.innerText = "GRABANDO";
                    else if (iniciado) el.innerText = "Calibrando...";
                    else el.innerText = "Listo para iniciar";
                }, 3000);
            }
        }

        window.addEventListener('click', (e) => {
            if (!calibracionTerminada || trackerPausado) return;
            const menu = document.getElementById('controlMenu');
            if ((menu && menu.contains(e.target)) || e.target.classList.contains('cal-point')) return;

            const nuevoClic = {
                id: datosClics.length + 1,
                x: Math.floor(e.pageX),
                y: Math.floor(e.pageY),
                timestamp: Date.now()
            };
            datosClics.push(nuevoClic);
            dibujarPuntoClic(nuevoClic);
            actualizarUI();
        });

        function dibujarPuntoClic(clic) {
            const capa = document.getElementById('capa-clics');
            const div = document.createElement('div');
            div.className = 'punto-clic';
            div.style.left = clic.x + 'px';
            div.style.top = clic.y + 'px';
            div.innerText = clic.id;
            capa.appendChild(div);
        }

        function actualizarUI() {
            document.getElementById('st-gaze').innerText = acumuladorPuntos.length;
            document.getElementById('st-clics').innerText = datosClics.length;
        }

        function eliminarUltimoClic() {
            if (datosClics.length > 0) {
                datosClics.pop();
                const capa = document.getElementById('capa-clics');
                if (capa.lastChild) capa.removeChild(capa.lastChild);
                actualizarUI();
                setMensajeEstado("√öltimo clic eliminado");
            }
        }

        // Eventos de teclado
        document.addEventListener('keydown', async (event) => {    
            if (event.key === 'Enter' && !iniciado) {
                iniciado = true;
                document.getElementById('instrucciones-inicio').style.display = 'none';
                document.querySelectorAll('.cal-point').forEach(p => p.style.display = 'block');
                document.body.style.overflow = 'hidden';
                setMensajeEstado("Calibrando...", true);
                await iniciarWebGazer();
            }


            if (event.key === 'ArrowRight' && iniciado) {
                cambiarSitio('next');
            }

            if (event.key === 'ArrowLeft' && iniciado) {
                cambiarSitio('previous');
            }   
            
            if (event.code === 'Space' && iniciado && calibracionTerminada) {
                event.preventDefault();
                const menu = document.getElementById('controlMenu');
                if (menu.style.display === 'block') {
                    cerrarMenuYReanudar();
                } else {
                    abrirMenuYArrestar();
                }
            }

            if (event.key.toLowerCase() === 'c' && iniciado) {
                toggleCamara();
                setMensajeEstado(camaraManualVisible ? "C√°mara visible" : "C√°mara oculta");
            }

            // Tecla V para mostrar/ocultar el panel de estado
            if (event.key.toLowerCase() === 'v') {
                    togglePanelEstado();
            }

        });

        /* 
         * Funciones de OPEN/CLOSE menu de control (con tecla Espacio)
         * Pausa captura de datos, hacer resume al cerrar ventana 
         * 
         */

        function abrirMenuYArrestar() {
            document.getElementById('controlMenu').style.display = 'block';
            trackerPausado = true;
            webgazer.pause();
            setMensajeEstado("PAUSADO", true);
            
            const dot = document.getElementById('webgazerDot');
            if(dot) dot.classList.add('oculto-tracker');
        }

        function cerrarMenuYReanudar() {
            document.getElementById('controlMenu').style.display = 'none';
            trackerPausado = false;
            webgazer.resume();
            setMensajeEstado("GRABANDO", true);
            
            if(!camaraManualVisible) {
                const dot = document.getElementById('webgazerDot');
                if(dot) dot.classList.remove('oculto-tracker');
            }
        }

        // Ver/Ocultar c√°mara de tracking facial 
        function toggleCamara() {
            camaraManualVisible = !camaraManualVisible;
            const ids = ['webgazerVideoContainer', 'webgazerVideoCanvas', 'webgazerFaceOverlay', 'webgazerDot'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) camaraManualVisible ? el.classList.remove('oculto-tracker') : el.classList.add('oculto-tracker');
            });
        }

        // Ver/Ocultar ventana de estado (superior derecha) 
        function togglePanelEstado() {
            const panel = document.getElementById('estado-ui');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
              //  setMensajeEstado("Panel visible");
            } else {
                panel.style.display = 'none';
            }
        }

        /* 
         * Calibraci√≥n y uso de webgazer.js  
         * 
         * 
         */
        async function iniciarWebGazer() {
            await webgazer.setGazeListener((data, elapsedTime) => {
                if (data == null || trackerPausado) return;
                
                document.getElementById('cur-x').innerText = Math.floor(data.x);
                document.getElementById('cur-y').innerText = Math.floor(data.y + window.scrollY);

                if (elapsedTime - ultimoRegistro > 100) {
                    acumuladorPuntos.push({
                        x: Math.floor(data.x),
                        y: Math.floor(data.y + window.scrollY) 
                    });
                    ultimoRegistro = elapsedTime;
                    actualizarUI();
                }
            }).begin();
            webgazer.showVideoPreview(true).showPredictionPoints(true);
        }

        function calibrate(elemento) {
            const id = elemento.id;
            if (!clicsPorPunto[id]) clicsPorPunto[id] = 0;
            clicsPorPunto[id]++;
            elemento.style.opacity = 0.4 + (clicsPorPunto[id] * 0.12);
            
            setMensajeEstado(`Punto ${id}: ${clicsPorPunto[id]}/5`, true);

            if (clicsPorPunto[id] >= CLICS_NECESARIOS) {
                elemento.classList.add('finished');
                verificarCalibracionCompleta();
            }
        }

        function verificarCalibracionCompleta() {
            const terminados = document.querySelectorAll('.cal-point.finished').length;
            if (terminados === 9) {
                calibracionTerminada = true;
                acumuladorPuntos = []; 
                document.body.style.overflowY = 'auto';
                
                camaraManualVisible = false;
                const ids = ['webgazerVideoContainer', 'webgazerVideoCanvas', 'webgazerFaceOverlay', 'webgazerDot'];
                ids.forEach(id => document.getElementById(id)?.classList.add('oculto-tracker'));
                
                setMensajeEstado("CALIBRACI√ìN OK. GRABANDO...", false);
                actualizarUI();
            }
        }

        /* 
         * EXPORTAR JSON 
         * Guardar datos en servidor de gaze-n.json y clics-n.json de una sesi√≥n 
         * 
         */
        async function exportarJSON() {
            const suffix = `${currentSite}`;
            setMensajeEstado("Guardando en servidor...");

            /*
            // Exportar Gaze
            const gazeData = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(acumuladorPuntos));
            const gazeLink = document.createElement('a');
            gazeLink.setAttribute("href", gazeData);
            gazeLink.setAttribute("download", `heatmap${suffix}.json`);
            gazeLink.click();

            // Exportar Clics
            setTimeout(() => {
                const clicsData = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(datosClics));
                const clicsLink = document.createElement('a');
                clicsLink.setAttribute("href", clicsData);
                clicsLink.setAttribute("download", `clicks${suffix}.json`);
                clicsLink.click();
            }, 500);
            */
            try {
                /* 
                 * Array de datos, 
                 * sufijo para identificar fichero, ej. "clics-1.json", "gaze-1.json"
                 */ 
                const datosGAZE = { puntos: acumuladorPuntos, suffix: suffix };
                const datosCLICS = { puntos: datosClics, suffix: suffix };

                /* 
                 * USAR RUTAS RELATIVAS FETCHING 
                 * realizar dos llamadas a fetch  
                 * antes por separado 
                 * const resGaze = await fetch('http://localhost:3000/guardar-gaze', {
                 *       method: 'POST',
                 *       headers: { 'Content-Type': 'application/json' },
                 *       body: JSON.stringify(datosGAZE)
                 *       });
                 */

                const [resGaze, resClics] = await Promise.all([
                    fetch('/guardar-gaze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(datosGAZE)
                        }),
                    fetch('/guardar-clics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(datosCLICS)
                        })
                ]);

                if (resGaze.ok && resClics.ok) {
                        setMensajeEstado("DATOS GUARDADOS CORRECTAMENTE");
                    } else {
                        setMensajeEstado("Error en el servidor" + resGaze.status);
                    }
            } catch (error) {
                console.error("Error conexi√≥n:", error);
                setMensajeEstado("Error de conexi√≥n con servidor");
            }    
        }

        /*
         * DATOS DE USUARIO PARA CERRAR SESION
         */
        async function confirmarFinalizacion() {
            // Obtenemos el valor del input de fecha
            const fechaManual = document.getElementById('user-date').value;
            // Generamos la hora exacta del sistema
            const ahora = new Date();
            const horaExacta = ahora.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const userData = {
                username: document.getElementById('user-name').value,
                edad: document.getElementById('user-age').value,
                sexo: document.getElementById('user-sex').value,
                grupo: document.getElementById('user-group').value,
                lugar: document.getElementById('user-loc').value,
                fecha: fechaManual,         // Ejemplo: "2026-01-31"
                hora_fin: horaExacta,       // Ejemplo: "18:15:05"
                timestamp: ahora.getTime(), // Formato num√©rico √∫til para ordenar datos despu√©s
                sitioFinal: currentSite
            };

            // nombre usr obligatorio 
            if (!userData.username) {
                alert("Por favor, introduce un nombre.");
                return;
            }

            try {
                // 1. Guardamos primero los datos de navegaci√≥n (opcional si ya lo haces)
                await exportarJSON(); 

                // 2. Guardamos los datos del usuario en users.json
                const response = await fetch('/guardar-usuario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    // alert("Sesi√≥n finalizada con √©xito.");
                    location.reload(); // Reiniciamos la aplicaci√≥n
                } else {
                    alert("Error al guardar usuario en el servidor.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("No se pudo conectar con el servidor.");
            }
        }

        /*
         * Accion: Finalizar sesi√≥n 
         * guardar datos de usuario de testing
         */

        function finalizarSesion() {
            // Cerramos el men√∫ de control y abrimos el de datos de usuario
            webgazer.pause();
            //document.getElementById('controlMenu').style.display = 'none';
            document.getElementById('modal-usuario').style.display = 'block';
            // Autorellenar fecha actual
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('user-date').value = hoy;
            }

        /*
         * Control de ventana modal con datos de usuario
         */
        function cerrarModalUser() {
            document.getElementById('modal-usuario').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
            // Reanudamos el men√∫ de control si el usuario cancel√≥
            document.getElementById('controlMenu').style.display = 'block';
        }

        /*
         * Actualiza tu funci√≥n prepararFinalizacion
         */
        function prepararFinalizacion() {
            document.getElementById('controlMenu').style.display = 'none';
            document.getElementById('modal-usuario').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
        }


    </script>
</body>
</html>